-- TABLE FOR SUPPLY EVENTS
CREATE TABLE SPLY_TBL (
	SPLY_ID UUID NOT NULL, -- UNIQUE IDENTIFIER FOR THE SUPPLY EVENT
	IS_RQO BOOLEAN NOT NULL DEFAULT FALSE, -- IDENTIFIES WHETHER THE SUPPLY IS A REQUEST
	TYP_MNEMONIC VARCHAR(64) NOT NULL, -- THE TYPE OF SUPPLY EVENT
	SRC_ENT_ID UUID NOT NULL, -- THE UUID OF THE SOURCE ENTITY THAT RECEIVED THE EVENT
	TRG_ENT_ID UUID NOT NULL, -- THE UUID OF THE TARGET ENTITY (PATIENT OR FACILITY)
	USR_ID UUID NOT NULL, -- THE UUID OF THE USER WHICH INITIATED THE SUPPLY EVENT
	ACT_UTC TIMESTAMPTZ NOT NULL, -- THE TIME THAT THE TRANSFER OCCURRED
	FULFILL_ID UUID, -- THE SUPPLY REQUEST WHICH THIS OBJECT FULFILLS
	CONSTRAINT PK_SPLY_TBL PRIMARY KEY (SPLY_ID)
);

-- TABLE FOR SUPPLY MATERIALS
CREATE TABLE SPLY_MAT_TBL (
	SPLY_MAT_ID UUID NOT NULL DEFAULT uuid_generate_v4(), -- THE UUID FOR THE MATERIAL RELATIONSHIP
	SPLY_ID UUID NOT NULL, -- THE UUID OF THE SUPPLY EVENT
	MAT_ID UUID NOT NULL, -- THE MATERIAL WHICH WAS SUPPLIED
	MMAT_ID UUID, -- THE MANUFACTURED MATERIAL WHICH WAS SUPPLIED
	QTY INT NOT NULL, -- THE QUANTITY OF SUPPLIED MATERIALS
	CONSTRAINT PK_SPLY_MAT_TBL PRIMARY KEY (SPLY_MAT_ID),
	CONSTRAINT FK_SPLY_MAT_SPLY_MAT_TBL FOREIGN KEY (SPLY_ID) REFERENCES SPLY_TBL(SPLY_ID),
	CONSTRAINT FK_SPLY_MAT_MMAT_TBL FOREIGN KEY (MMAT_ID) REFERENCES MMAT_TBL(MMAT_ID),
	CONSTRAINT FK_SPLY_MAT_MAT_TBL FOREIGN KEY (MAT_ID) REFERENCES MAT_TBL (MAT_ID)
);

-- TABLE FOR ACT EXTENSIONS
CREATE TABLE ACT_EXT_TBL (
	ACT_EXT_ID UUID NOT NULL, -- THE UNIQUE IDENTIFIER FOR THE EXTENSION
	ACT_ID UUID NOT NULL, -- THE IDENTIFIER OF THE ACT TO WHICH THIS EXTENSION BELONGS
	EXT_TYP VARCHAR(256) NOT NULL, -- THE TYPE OF EXTENSION
	EXT_VALUE VARCHAR(256) NOT NULL, -- THE VALUE OF THE EXTENSION
	CONSTRAINT PK_ACT_EXT_TBL PRIMARY KEY (ACT_EXT_ID)
);

-- CONDITION TABLES
CREATE TABLE COND_TBL (
	ACT_ID UUID NOT NULL, -- THE UNIQUE IDENTIFIER FOR THE ACT IDENTIFIER
	CRT_UTC TIMESTAMPTZ NOT NULL, -- THE TIME THAT THE CONDITION WAS RECORDED
	ACT_UTC TIMESTAMPTZ NOT NULL, -- THE TIME TAHT THE CONDITION WAS OBSERVED
	TYP_MNEMONIC VARCHAR(64) NOT NULL, -- INDICATES THE TYPE OF CONDITION
	PROB_MNEMONIC VARCHAR(64), -- INDICATES THE CODED VALUE OF THE CONDITION
	SEV_MNEMONIC VARCHAR(64), -- THE SEVERITY OF THE CONDITION
	IS_CONCERN BOOLEAN NOT NULL DEFAULT FALSE, -- TRUE IF THE PROBLEM IS A CONCERN
	USR_ID UUID NOT NULL, -- THE USER IDENTIFIER THAT REPORTED THE CONDITION
	FAC_ID UUID NOT NULL, -- THE FACILITY IDENTIFIER WHERE THE CONDITION WAS REPORTED
	PAT_ID UUID NOT NULL, -- THE PATIENT ON WHICH THE CONDITION EXISTS
	CONSTRAINT PK_ACT_ID PRIMARY KEY (ACT_ID)
);

ALTER TABLE PAT_EXT_TBL RENAME TO ENT_EXT_TBL;
ALTER TABLE ENT_EXT_TBL RENAME COLUMN PAT_EXT_ID TO ENT_EXT_ID;
ALTER TABLE ENT_EXT_TBL RENAME COLUMN PAT_ID TO ENT_ID;
ALTER TABLE ENT_EXT_TBL DROP CONSTRAINT FK_PAT_EXT_PAT_ID;

-- ACT LIST
CREATE TABLE ACT_LIST_TBL (
	ACT_ID UUID NOT NULL, -- THE IDENTIFIER OF THE LIST
	LOC_ID UUID NOT NULL, -- THE LOCATION WHERE THE LIST WAS CREATED
	START_UTC TIMESTAMPTZ NOT NULL, -- THE TIME THAT ACT LIST STARTED
	STOP_UTC TIMESTAMPTZ,  -- THE TIME THAT THE ACT FINISHED
	AUT_ID UUID NOT NULL, -- THE USER WHICH CREATED THE ACT
	TYP_MNEMONIC VARCHAR(64) NOT NULL, -- THE TYPE OF LIST
	CONSTRAINT PK_ACT_LIST_TBL PRIMARY KEY (ACT_ID)
);

-- ACT LOCATIONS <> LINK
CREATE TABLE ACT_LIST_LOC_TBL (
	ACT_ID UUID NOT NULL, -- THE IDENTIFIER OF THE ACT TO WHICH THE LOCATION IS ASSIGNED
	LOC_ID UUID NOT NULL, -- THE LOCATION WHERE THE ACT OCCURRED
	CONSTRAINT PK_ACT_LIST_LOC_TBL PRIMARY KEY (ACT_ID, LOC_ID)
);

-- ACT LOCATIONS <> EVENTS LINK
CREATE TABLE ACT_LIST_ACT_REL_TBL (
	ACT_ID UUID NOT NULL, -- THE IDENTIFIER OF THE SOURCE ACT
	SBADM_ACT_ID UUID NOT NULL, -- THE IDENTIFIER OF THE ADMINISTRATION THAT OCCURRED
	CONSTRAINT PK_ACT_LIST_REL_TBL PRIMARY KEY (ACT_ID, SBADM_ACT_ID)
);

CREATE INDEX SBADM_TBL_TYPE_IDX ON SBADM_TBL(TYPE_MNEMONIC);	
ALTER TABLE SPLY_TBL ADD CRT_ETL_ID UUID NOT NULL;
ALTER TABLE COND_TBL ADD CRT_ETL_ID UUID NOT NULL;
ALTER TABLE ACT_LIST_TBL ADD CRT_ETL_ID UUID NOT NULL;
ALTER TABLE SPLY_TBL ALTER TRG_ENT_ID DROP NOT NULL;
ALTER TABLE SPLY_TBL ADD ACCEPT_ID UUID;
ALTER TABLE SPLY_TBL ADD ENC_ID UUID;

ALTER TABLE ent_ext_tbl ALTER ext_value TYPE TEXT;
ALTER TABLE act_ext_tbl ALTER ext_value TYPE TEXT;

CREATE TABLE fac_id_tbl
(
  fac_id uuid NOT NULL,
  nsid character varying(64) NOT NULL,
  ext_id character varying(64),
  CONSTRAINT pk_fac_id_tbl PRIMARY KEY (fac_id, nsid),
  CONSTRAINT fk_fac_fac_tbl FOREIGN KEY (fac_id)
      REFERENCES public.fac_tbl (fac_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);